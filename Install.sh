#!/bin/bash
# Lofi Streamer Dashboard Add-On Installer (v3.5.1)
# GENDEMIK DIGITAL ‚Äì installs the dashboard as an add-on to an existing LofiStream

set -e

echo "üéõÔ∏è Lofi Streamer Dashboard Add-On Installer"
echo "GENDEMIK DIGITAL ‚Äì Raspberry Pi 4/5"
echo

# ---------- Detect user / paths ----------
if [ "$SUDO_USER" ]; then
  USER_NAME="$SUDO_USER"
else
  USER_NAME="$(logname 2>/dev/null || echo "$USER")"
fi

HOME_DIR=$(eval echo "~$USER_NAME")
BASE_DIR="$HOME_DIR/LofiStream"
DASH_DIR="$BASE_DIR/Dashboard"

echo "‚ûï Installing for user: $USER_NAME"
echo "üìÅ HOME:  $HOME_DIR"
echo "üìÅ BASE:  $BASE_DIR"
echo "üìÅ DASH:  $DASH_DIR"
echo

if [ ! -d "$BASE_DIR" ]; then
  echo "‚ùå LofiStream base folder not found: $BASE_DIR"
  echo "   Please install the main Lofi Streamer first, then run this installer again."
  exit 1
fi

# ---------- Install dependencies ----------
echo "üì¶ Installing dashboard dependencies (Flask, psutil)‚Ä¶"
sudo apt update -y
sudo apt install -y python3-flask python3-psutil

# ---------- Create dashboard structure ----------
echo "üìÅ Creating dashboard folders‚Ä¶"
mkdir -p "$DASH_DIR/templates" "$DASH_DIR/static"

RAW_BASE="https://raw.githubusercontent.com/teqherself/Lofi-Streamer-Pi4-dashboard/main/Dashboard"

echo "üåê Fetching dashboard files from GitHub‚Ä¶"
# Core scripts
wget -qO "$DASH_DIR/dashboard.py"     "$RAW_BASE/dashboard.py"
wget -qO "$DASH_DIR/system_helper.sh" "$RAW_BASE/system_helper.sh"

# Templates
wget -qO "$DASH_DIR/templates/index.html" "$RAW_BASE/templates/index.html"
wget -qO "$DASH_DIR/templates/login.html" "$RAW_BASE/templates/login.html"

# Static
wget -qO "$DASH_DIR/static/style.css"     "$RAW_BASE/static/style.css"

chmod +x "$DASH_DIR/dashboard.py" "$DASH_DIR/system_helper.sh"

echo "‚úÖ Dashboard files installed."

# ---------- systemd service ----------
SERVICE_FILE="/etc/systemd/system/lofi-dashboard.service"

echo "üßæ Writing systemd service: $SERVICE_FILE"

sudo bash -c "cat > '$SERVICE_FILE' <<EOF
[Unit]
Description=Lofi Streamer Dashboard (GENDEMIK DIGITAL)
After=network-online.target
Wants=network-online.target

[Service]
User=$USER_NAME
WorkingDirectory=$DASH_DIR
ExecStart=/usr/bin/python3 $DASH_DIR/dashboard.py
Restart=always
RestartSec=5
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
EOF
"

# ---------- sudoers for dashboard controls ----------
SUDOERS_FILE="/etc/sudoers.d/lofi-dashboard"
DASH_HELPER="$DASH_DIR/system_helper.sh"

echo "üßæ Writing sudoers snippet: $SUDOERS_FILE"

sudo bash -c "cat > '$SUDOERS_FILE' <<EOF
# Auto-generated by Lofi Streamer Dashboard installer
# User: $USER_NAME

$USER_NAME ALL=NOPASSWD: /usr/bin/systemctl start lofi-streamer
$USER_NAME ALL=NOPASSWD: /usr/bin/systemctl stop lofi-streamer
$USER_NAME ALL=NOPASSWD: /usr/bin/systemctl restart lofi-streamer
$USER_NAME ALL=NOPASSWD: /usr/bin/systemctl status lofi-streamer
$USER_NAME ALL=NOPASSWD: /usr/bin/journalctl -u lofi-streamer -n 40 --no-pager
$USER_NAME ALL=NOPASSWD: /usr/bin/journalctl -u lofi-dashboard -n 40 --no-pager
$USER_NAME ALL=NOPASSWD: /usr/bin/pkill
$USER_NAME ALL=NOPASSWD: /usr/bin/lsof
$USER_NAME ALL=NOPASSWD: /usr/bin/vcgencmd
$USER_NAME ALL=NOPASSWD: /usr/sbin/reboot
$USER_NAME ALL=NOPASSWD: $DASH_HELPER
EOF
"

sudo chmod 440 "$SUDOERS_FILE"

echo "‚úÖ sudoers configured for user: $USER_NAME"

# ---------- Enable + start dashboard ----------
echo "üîÅ Reloading systemd‚Ä¶"
sudo systemctl daemon-reload

echo "üöÄ Enabling and starting lofi-dashboard.service‚Ä¶"
sudo systemctl enable lofi-dashboard >/dev/null 2>&1 || true
sudo systemctl restart lofi-dashboard

echo
echo "‚úÖ Lofi Streamer Dashboard installed."
echo "üì° Open: http://<pi-ip>:4455  (use 'hostname -I' to get the IP)"
echo "   Login with the password you configured inside dashboard.py."
echo
echo "‚ÑπÔ∏è If anything looks off, check:"
echo "   sudo systemctl status lofi-dashboard"
echo "   journalctl -u lofi-dashboard -n 50 --no-pager"
