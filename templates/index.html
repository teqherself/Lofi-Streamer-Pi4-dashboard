<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lofi Streamer Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <span class="brand-title">Lofi Streamer Dashboard</span>
      <span class="brand-sub">GENDEMIK DIGITAL · Susan v3.4</span>
    </div>
    <form method="POST" action="{{ url_for('logout') }}">
      <button type="submit" class="btn btn-secondary">Logout</button>
    </form>
  </header>

  <main class="grid">
    <!-- Streamer & Camera -->
    <section class="tile tile-status">
      <h2>Streamer & Camera</h2>
      <div class="status-row">
        <span class="label">Streamer:</span>
        <span id="streamer_state" class="pill pill-unknown">Unknown</span>
      </div>
      <div class="status-row">
        <span class="label">Camera:</span>
        <span id="camera_state" class="pill pill-unknown">Unknown</span>
      </div>
      <div class="status-row">
        <span class="label">Now Playing:</span>
        <span id="now_playing" class="now-playing">loading…</span>
      </div>
    </section>

    <!-- System Info -->
    <section class="tile tile-system">
      <h2>System Info</h2>
      <ul class="sys-list">
        <li>CPU: <span id="cpu">–</span></li>
        <li>RAM: <span id="ram">–</span></li>
        <li>Disk: <span id="disk">–</span></li>
        <li>Temp: <span id="temp">–</span></li>
        <li>Uptime: <span id="uptime">–</span></li>
        <li>Load: <span id="load">–</span></li>
      </ul>
    </section>

    <!-- Logs -->
    <section class="tile tile-log">
      <h2>Streamer Log (last 40 lines)</h2>
      <pre id="logbox" class="logbox">Loading log…</pre>
    </section>

    <!-- Controls -->
    <section class="tile tile-controls">
      <h2>Controls</h2>
      <div class="controls-grid">
        <button class="btn btn-primary" data-action="streamer/start">Start Streamer</button>
        <button class="btn btn-warning" data-action="streamer/restart">Restart Streamer</button>
        <button class="btn btn-danger" data-action="streamer/stop">Stop Streamer</button>

        <button class="btn btn-outline" data-action="camera/restart">Restart Camera Only</button>

        <a href="{{ url_for('reboot') }}" class="btn btn-danger btn-wide">
          Reboot System (2-step)
        </a>
      </div>

      <div id="action_status" class="action-status">Ready.</div>
    </section>
  </main>

  <script>
    async function refreshStatus() {
      try {
        const res = await fetch("/api/status", { cache: "no-store" });
        if (!res.ok) return;
        const data = await res.json();

        // Streamer
        const st = data.streamer || {};
        const streamerStateEl = document.getElementById("streamer_state");
        streamerStateEl.textContent = st.state || "unknown";
        streamerStateEl.className = "pill " + (st.active ? "pill-ok" : "pill-bad");

        // Camera
        const cam = data.camera || {};
        const cameraStateEl = document.getElementById("camera_state");
        cameraStateEl.textContent = cam.detail || "unknown";
        cameraStateEl.className = "pill " + (cam.active ? "pill-ok" : "pill-warn");

        // Now playing
        document.getElementById("now_playing").textContent = data.now_playing || "No track";

        // System
        const sys = data.system || {};
        document.getElementById("cpu").textContent = sys.cpu || "–";
        document.getElementById("ram").textContent = sys.ram || "–";
        document.getElementById("disk").textContent = sys.disk || "–";
        document.getElementById("temp").textContent = sys.temp || "–";
        document.getElementById("uptime").textContent = sys.uptime || "–";
        document.getElementById("load").textContent = sys.load || "–";

        // Logs
        const logs = data.logs || [];
        document.getElementById("logbox").textContent = logs.join("\\n");

      } catch (e) {
        console.error("Status refresh error", e);
      }
    }

    async function sendAction(action) {
      const statusEl = document.getElementById("action_status");
      statusEl.textContent = "Working…";

      let url = "";
      let options = { method: "POST" };

      if (action.startsWith("streamer/")) {
        const cmd = action.split("/")[1];
        url = "/action/streamer/" + cmd;
      } else if (action === "camera/restart") {
        url = "/action/restart_camera";
      } else {
        statusEl.textContent = "Unknown action.";
        return;
      }

      try {
        const res = await fetch(url, options);
        const data = await res.json();
        statusEl.textContent = data.message || (data.ok ? "OK." : "Error.");
        refreshStatus();
      } catch (e) {
        statusEl.textContent = "Request failed.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Wire buttons
      document.querySelectorAll("[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          sendAction(action);
        });
      });

      refreshStatus();
      setInterval(refreshStatus, 2000);
    });
  </script>
</body>
</html>
